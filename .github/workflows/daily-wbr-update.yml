name: Daily WBR Dashboard Update

on:
  schedule:
    # Run daily at 9 AM UTC (adjust timezone as needed)
    # For PST: 9 AM UTC = 1 AM PST (or 2 AM PDT)
    # For EST: 9 AM UTC = 4 AM EST (or 5 AM EDT)
    - cron: '0 9 * * *'
  workflow_dispatch:  # Allow manual trigger from GitHub UI

jobs:
  update-dashboard:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: Install dependencies
        working-directory: automated-wbr-update
        run: |
          pip install --upgrade pip
          pip install requests python-dotenv databricks-sdk
      
      - name: Update Coda Dashboard
        working-directory: automated-wbr-update
        env:
          CODA_API_TOKEN: ${{ secrets.CODA_API_TOKEN }}
          CODA_DOC_ID: ${{ secrets.CODA_DOC_ID }}
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
          DATABRICKS_SQL_WAREHOUSE_ID: ${{ secrets.DATABRICKS_SQL_WAREHOUSE_ID }}
        run: |
          python3 notebooks/update_coda_dashboard_daily.py
      
      - name: Create issue on failure
        if: failure()
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸš¨ WBR Dashboard Update Failed',
                body: `The daily WBR dashboard update failed on ${new Date().toISOString()}. Check the workflow logs for details: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
              });
            } catch (error) {
              console.log('Could not create issue (issues may be disabled):', error.message);
            }
